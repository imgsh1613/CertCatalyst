<!-- templates/view_student.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Details - Certification Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="dashboard-container">
        <nav class="sidebar">
            <div class="logo">Certification Tracker</div>
            <div class="user-info">
                <div class="user-name">{{ session.full_name }}</div>
                <div class="user-role">Teacher</div>
            </div>
            <ul class="nav-links">
                <li><a href="{{ url_for('teacher_dashboard') }}">Dashboard</a></li>
                <li><a href="{{ url_for('add_student') }}">Add Student</a></li>
                <li><a href="{{ url_for('logout') }}">Logout</a></li>
            </ul>
        </nav>
        
        <main class="main-content">
            <header>
                <h1>Student Details</h1>
                <a href="{{ url_for('teacher_dashboard') }}" class="btn btn-back">Back to Dashboard</a>
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            </header>
            
            <div class="student-info">
                <h2>{{ student.full_name }}</h2>
                <p>Email: {{ student.email }}</p>
            </div>
            
            <div class="certificates-list">
                <h3>Student Certificates</h3>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th>Certificate Name</th>
                                <th>Issue Date</th>
                                <th>Status</th>
                                <th>Certificate</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cert in certificates %}
                            <tr>
                                <td>{{ cert.course_name }}</td>
                                <td>{{ cert.certificate_name }}</td>
                                <td>{{ cert.issue_date }}</td>
                                <td>
                                    <span class="badge badge-{{ cert.verification_status }}">
                                        {{ cert.verification_status }}
                                    </span>
                                </td>
                                <td>
                                    <button onclick="openPDF('{{ cert.certificate_file }}', '{{ cert.certificate_name }}')" class="btn btn-sm">View</button>
                                </td>
                                <td>
                                    {% if cert.verification_status == 'pending' %}
                                    <a href="{{ url_for('verify_certificate', certificate_id=cert.certificate_id, status='verified') }}" 
                                       class="btn btn-sm btn-success">Verify</a>
                                    <a href="{{ url_for('verify_certificate', certificate_id=cert.certificate_id, status='rejected') }}" 
                                       class="btn btn-sm btn-danger">Reject</a>
                                    {% elif cert.verification_status == 'rejected' %}
                                    <a href="{{ url_for('verify_certificate', certificate_id=cert.certificate_id, status='verified') }}" 
                                       class="btn btn-sm btn-success">Verify</a>
                                    {% elif cert.verification_status == 'verified' %}
                                    <a href="{{ url_for('verify_certificate', certificate_id=cert.certificate_id, status='rejected') }}" 
                                       class="btn btn-sm btn-danger">Reject</a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6">No certificates uploaded yet</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
    
    <script>
    function openPDF(url, filename) {
        console.log('Opening PDF:', url);
        
        if (!url || url.trim() === '') {
            alert('No certificate URL found!');
            return;
        }
        
        // Create PDF viewer with immediate fallback detection
        const newWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
        if (!newWindow) {
            alert('Popup blocked! Please allow popups and try again.');
            return;
        }
        
        newWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Certificate: ${filename || 'PDF Document'}</title>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <style>
                    body { 
                        margin: 0; 
                        padding: 0; 
                        background: #f5f5f5; 
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                        color: #333;
                    }
                    .header { 
                        background: #2c3e50; 
                        padding: 20px; 
                        display: flex; 
                        justify-content: space-between; 
                        align-items: center;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    }
                    .header h2 { 
                        margin: 0; 
                        font-size: 20px; 
                        color: white;
                        font-weight: 300;
                    }
                    .controls { 
                        display: flex; 
                        gap: 10px; 
                    }
                    .btn { 
                        background: #3498db; 
                        color: white; 
                        border: none; 
                        padding: 10px 20px; 
                        border-radius: 6px; 
                        cursor: pointer; 
                        font-size: 14px;
                        transition: all 0.3s ease;
                        font-weight: 500;
                    }
                    .btn:hover { 
                        background: #2980b9; 
                        transform: translateY(-1px);
                    }
                    .btn.success { background: #27ae60; }
                    .btn.success:hover { background: #229954; }
                    .btn.danger { background: #e74c3c; }
                    .btn.danger:hover { background: #c0392b; }
                    
                    .content { 
                        padding: 40px; 
                        text-align: center;
                        min-height: calc(100vh - 100px);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    .options-container {
                        background: white;
                        padding: 40px;
                        border-radius: 12px;
                        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
                        max-width: 600px;
                        width: 100%;
                    }
                    .icon { 
                        font-size: 64px; 
                        margin-bottom: 20px;
                        color: #3498db;
                    }
                    .options-container h2 { 
                        color: #2c3e50; 
                        margin-bottom: 15px;
                        font-weight: 300;
                    }
                    .options-container p { 
                        margin: 15px 0; 
                        line-height: 1.6; 
                        color: #7f8c8d;
                    }
                    .action-buttons {
                        display: flex;
                        flex-wrap: wrap;
                        gap: 15px;
                        justify-content: center;
                        margin: 30px 0;
                    }
                    .action-btn { 
                        background: #3498db; 
                        color: white; 
                        padding: 15px 30px; 
                        text-decoration: none; 
                        border-radius: 8px; 
                        display: inline-flex;
                        align-items: center;
                        gap: 10px;
                        font-weight: 500;
                        font-size: 16px;
                        transition: all 0.3s ease;
                        border: none;
                        cursor: pointer;
                    }
                    .action-btn:hover {
                        background: #2980b9;
                        transform: translateY(-2px);
                        box-shadow: 0 4px 20px rgba(52,152,219,0.3);
                    }
                    .action-btn.success { background: #27ae60; }
                    .action-btn.success:hover { 
                        background: #229954;
                        box-shadow: 0 4px 20px rgba(39,174,96,0.3);
                    }
                    .help-text {
                        background: #ecf0f1;
                        padding: 20px;
                        border-radius: 8px;
                        margin-top: 25px;
                        font-size: 14px;
                        color: #7f8c8d;
                        line-height: 1.5;
                    }
                    @media (max-width: 600px) {
                        .content { padding: 20px; }
                        .options-container { padding: 25px; }
                        .action-buttons { flex-direction: column; }
                        .header { padding: 15px; }
                        .controls { flex-direction: column; gap: 8px; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <h2>📄 ${filename || 'Certificate Viewer'}</h2>
                    <div class="controls">
                        <button class="btn success" onclick="tryDownload()">⬇️ Download</button>
                        <button class="btn" onclick="openOriginal()">🔗 Open Original</button>
                        <button class="btn danger" onclick="window.close()">✕ Close</button>
                    </div>
                </div>
                
                <div class="content">
                    <div class="options-container">
                        <div class="icon">📋</div>
                        <h2>Certificate Ready for Viewing</h2>
                        <p>Your certificate is available. Choose how you'd like to access it:</p>
                        
                        <div class="action-buttons">
                            <button class="action-btn success" onclick="tryDownload()">
                                ⬇️ Download PDF
                            </button>
                            <button class="action-btn" onclick="openOriginal()">
                                🌐 Open in Browser
                            </button>
                            <button class="action-btn" onclick="tryView()">
                                👁️ Try Viewer Again
                            </button>
                        </div>
                        
                        <div class="help-text">
                            <strong>💡 Tips:</strong><br>
                            • <strong>Download PDF:</strong> Saves the certificate to your computer<br>
                            • <strong>Open in Browser:</strong> Opens in a new tab (may prompt to download)<br>
                            • <strong>Having issues?</strong> Try using a different browser like Chrome or Firefox
                        </div>
                    </div>
                </div>
                
                <script>
                    function tryDownload() {
                        console.log('Downloading PDF:', '${url}');
                        const a = document.createElement('a');
                        a.href = '${url}';
                        a.download = '${filename || 'certificate.pdf'}';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        // Show confirmation
                        setTimeout(() => {
                            alert('Download started! Check your Downloads folder.');
                        }, 500);
                    }
                    
                    function openOriginal() {
                        console.log('Opening original URL:', '${url}');
                        const newTab = window.open('${url}', '_blank');
                        if (!newTab) {
                            alert('Popup blocked! Please allow popups or try downloading instead.');
                        }
                    }
                    
                    function tryView() {
                        // Replace content with iframe attempt
                        document.querySelector('.content').innerHTML = \`
                            <div style="width: 100%; height: 600px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                                <iframe src="${url}" 
                                        style="width: 100%; height: 100%; border: none;"
                                        onload="console.log('PDF loaded in iframe')"
                                        onerror="showFallbackAgain()">
                                </iframe>
                            </div>
                            <p style="margin-top: 15px; color: #7f8c8d;">
                                If the PDF doesn't appear above, use the Download or Open in Browser options.
                            </p>
                        \`;
                    }
                    
                    // Log for debugging
                    console.log('Certificate viewer loaded for:', '${url}');
                <\/script>
            </body>
            </html>
        `);
    }
    // Test function
    console.log('PDF viewer functions loaded');
    // Test if function is loaded
    console.log('openPDF function loaded:', typeof openPDF === 'function');
    </script>
    
</body>

</html>





